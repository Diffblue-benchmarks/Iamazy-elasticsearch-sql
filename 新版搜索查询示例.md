elasticsearch-sql使用手册
=============================

[TOC]
---------------------
### 一、SQL基本结构
```sql
##搜索请求SQL结构
SELECT [fields] FROM [index.type] QUERY [score query condition] WHERE [bool query condition] ORDER BY [sort field] LIMIT [a,b]

##聚合查询SQL结构
SELECT [MAX(field),MIN(field),SUM(field),AVG(field)] from [index.type] QUERY [score query condition] WHERE [bool query condition] GROUP BY [agg methods]
```

#### 请求接口
[POST] http://10.10.2.84:8765/sql/explain

##### 请求参数
```json
{
    "sql":"sql语句",
    "params":"数组，可选参数"  在使用match等模糊搜索的时候需要填写
}
```
##### 请求参数示例
```json
{
    "sql":"select * from device_search where match(portInfo.deviceInfo.deviceBrand,'大华','prefix_length:21') and term(portInfo.port,80)",
    "params":["portInfo.port","portInfo.deviceInfo.deviceBrand"]
}
```
##### 返回值
返回解析后的查询DSL

以下所有的查询语句都基于新版ES搜索结构
-----------------------
##### 热身
```java
@Test
public void test(){
    String sql="select * from device_search";
    ElasticSql2DslParser sql2DslParser=new ElasticSql2DslParser();
    ElasticSqlParseResult parseResult = sql2DslParser.parse(sql);
    System.out.println(parseResult.toPrettyDsl(parseResult.toRequest()));
}
```
解析之后的DSL
```json
{
  "from": 0,
  "size": 15,
  "query": {
    "match_all": {
      "boost": 1
    }
  }
}
```

##### 1. Select,Match,Term
- [x] SQL Select *
- [x] SQL Where
- [x] ES Match
- [x] ES Term 
```java
@Test
public void testParseFromMethodSource(){
    String sql="select * from device_search where match(portInfo.deviceInfo.deviceBrand,'大华','prefix_length:21') and term(portInfo.port,80)";
    ElasticSql2DslParser sql2DslParser=new ElasticSql2DslParser();
    ElasticSqlParseResult parseResult = sql2DslParser.parse(sql,new String[]{"portInfo.port","portInfo.deviceInfo.deviceBrand"});
    System.out.println(parseResult.toPrettyDsl(parseResult.toRequest()));
}
```
解析后的DSL
```json
{
  "from": 0,
  "size": 15,
  "query": {
    "bool": {
      "filter": [
        {
          "bool": {
            "must": [
              {
                "match": {
                  "portInfo.deviceInfo.deviceBrand": {
                    "query": "大华",
                    "operator": "OR",
                    "prefix_length": 21,
                    "max_expansions": 50,
                    "fuzzy_transpositions": true,
                    "lenient": false,
                    "zero_terms_query": "NONE",
                    "auto_generate_synonyms_phrase_query": true,
                    "boost": 1
                  }
                }
              },
              {
                "term": {
                  "portInfo.port": {
                    "value": "80",
                    "boost": 1
                  }
                }
              }
            ],
            "adjust_pure_negative": true,
            "boost": 1
          }
        }
      ],
      "adjust_pure_negative": true,
      "boost": 1
    }
  }
}
```

##### 2. Select [fields],MatchPhrase,Term,Limit
- [x] Select [field]
- [x] MatchPhrase
- [x] Limit
```java
@Test
public void testParseLimit(){
    String sql="select portInfo.deviceInfo.deviceBrand,portInfo.port,ipInfo.ip from device_search where match_phrase(portInfo.deviceInfo.deviceBrand,'大华') and term(portInfo.port,80) limit 2,9";
    ElasticSql2DslParser sql2DslParser=new ElasticSql2DslParser();
    ElasticSqlParseResult parseResult = sql2DslParser.parse(sql,new String[]{"portInfo.port","portInfo.deviceInfo.deviceBrand"});
    System.out.println(parseResult.toPrettyDsl(parseResult.toRequest()));
}
```
解析之后的DSL
```json
{
  "from": 2,
  "size": 9,
  "query": {
    "bool": {
      "filter": [
        {
          "bool": {
            "must": [
              {
                "match_phrase": {
                  "portInfo.deviceInfo.deviceBrand": {
                    "query": "大华",
                    "slop": 0,
                    "zero_terms_query": "NONE",
                    "boost": 1
                  }
                }
              },
              {
                "term": {
                  "portInfo.port": {
                    "value": "80",
                    "boost": 1
                  }
                }
              }
            ],
            "adjust_pure_negative": true,
            "boost": 1
          }
        }
      ],
      "adjust_pure_negative": true,
      "boost": 1
    }
  },
  "_source": {
    "includes": [
      "portInfo.deviceInfo.deviceBrand",
      "portInfo.port",
      "ipInfo.ip"
    ],
    "excludes": []
  }
}
```

##### 3. Select [fields], Not Null ,Is ,Group By, Terms
- [x] SQL Is
- [x] SQL Not Null
- [x] SQL Group By
- [x] ES Terms Agg
```java
@Test
public void testParseTermsAgg(){
    String sql="select * from device_search where portInfo.port is not null and ipInfo.ip is not null group by terms(portInfo.port,5000),terms(ipInfo.ip,600)";
    ElasticSql2DslParser sql2DslParser=new ElasticSql2DslParser();
    ElasticSqlParseResult parseResult = sql2DslParser.parse(sql,new String[]{"portInfo.port","portInfo.deviceInfo.deviceBrand"});
    System.out.println(parseResult.toPrettyDsl(parseResult.toRequest()));
}
```
解析之后的DSL
```json
{
  "from": 0,
  "size": 15,
  "query": {
    "bool": {
      "filter": [
        {
          "bool": {
            "must": [
              {
                "exists": {
                  "field": "portInfo.port",
                  "boost": 1
                }
              },
              {
                "exists": {
                  "field": "ipInfo.ip",
                  "boost": 1
                }
              }
            ],
            "adjust_pure_negative": true,
            "boost": 1
          }
        }
      ],
      "adjust_pure_negative": true,
      "boost": 1
    }
  },
  "aggregations": {
    "portInfo.port_terms": {
      "terms": {
        "field": "portInfo.port",
        "size": 5000,
        "shard_size": 10000,
        "min_doc_count": 1,
        "shard_min_doc_count": 1,
        "show_term_doc_count_error": false,
        "order": [
          {
            "_count": "desc"
          },
          {
            "_key": "asc"
          }
        ]
      }
    },
    "ipInfo.ip_terms": {
      "terms": {
        "field": "ipInfo.ip",
        "size": 600,
        "shard_size": 1200,
        "min_doc_count": 1,
        "shard_min_doc_count": 1,
        "show_term_doc_count_error": false,
        "order": [
          {
            "_count": "desc"
          },
          {
            "_key": "asc"
          }
        ]
      }
    }
  }
}
```

##### 4. Select *, In, And, Not In, Between And, Group By, Terms Agg, Order By Desc, Limit
```java
@Test
public void testParseDeviceExists(){
    String sql="select * from device_search where deviceBrand in ( 'dahua','xiaohua' ) and vulType in ( 'ERROR' ) and deviceCategory in ( 'SS','VSS' ) and  resType ='vul_info' and vulInfo.vulExist='true' and portInfo.deviceInfo.deviceCategory not in ('Monitor','Network Equipment','OA','Voice and Video','Room Wiring') and lastModified between 1533398400000 and 1550799200976 group by terms(portInfo.port,50) order by lastModified desc limit 0,10";
    ElasticSql2DslParser sql2DslParser=new ElasticSql2DslParser();
    ElasticSqlParseResult parseResult = sql2DslParser.parse(sql);
    System.out.println(parseResult.toPrettyDsl(parseResult.toRequest()));
}
```
解析之后的DSL
```json
{
  "from": 0,
  "size": 10,
  "query": {
    "bool": {
      "filter": [
        {
          "bool": {
            "must": [
              {
                "terms": {
                  "deviceBrand": [
                    "dahua",
                    "xiaohua"
                  ],
                  "boost": 1
                }
              },
              {
                "terms": {
                  "vulType": [
                    "ERROR"
                  ],
                  "boost": 1
                }
              },
              {
                "terms": {
                  "deviceCategory": [
                    "SS",
                    "VSS"
                  ],
                  "boost": 1
                }
              },
              {
                "term": {
                  "resType": {
                    "value": "vul_info",
                    "boost": 1
                  }
                }
              },
              {
                "term": {
                  "vulInfo.vulExist": {
                    "value": "true",
                    "boost": 1
                  }
                }
              },
              {
                "bool": {
                  "must_not": [
                    {
                      "terms": {
                        "portInfo.deviceInfo.deviceCategory": [
                          "Monitor",
                          "Network Equipment",
                          "OA",
                          "Voice and Video",
                          "Room Wiring"
                        ],
                        "boost": 1
                      }
                    }
                  ],
                  "adjust_pure_negative": true,
                  "boost": 1
                }
              },
              {
                "range": {
                  "lastModified": {
                    "from": 1533398400000,
                    "to": 1550799200976,
                    "include_lower": true,
                    "include_upper": true,
                    "boost": 1
                  }
                }
              }
            ],
            "adjust_pure_negative": true,
            "boost": 1
          }
        }
      ],
      "adjust_pure_negative": true,
      "boost": 1
    }
  },
  "sort": [
    {
      "lastModified": {
        "order": "desc"
      }
    }
  ],
  "aggregations": {
    "portInfo.port_terms": {
      "terms": {
        "field": "portInfo.port",
        "size": 50,
        "shard_size": 100,
        "min_doc_count": 1,
        "shard_min_doc_count": 1,
        "show_term_doc_count_error": false,
        "order": [
          {
            "_count": "desc"
          },
          {
            "_key": "asc"
          }
        ]
      }
    }
  }
}
```

##### 5. Select *, Has Parent
```java
@Test
public void testHasParent(){
    String sql="select * from device_search where has_parent('ipInfo',ipInfo.ip between '10.10.2.221' and '221.221.221.221')";
    ElasticSql2DslParser sql2DslParser=new ElasticSql2DslParser();
    ElasticSqlParseResult parseResult = sql2DslParser.parse(sql);
    System.out.println(parseResult.toPrettyDsl(parseResult.toRequest()));
}
```
解析之后的json
```json
{
  "from": 0,
  "size": 15,
  "query": {
    "bool": {
      "filter": [
        {
          "bool": {
            "must": [
              {
                "has_parent": {
                  "query": {
                    "bool": {
                      "must": [
                        {
                          "range": {
                            "ipInfo.ip": {
                              "from": "10.10.2.221",
                              "to": "221.221.221.221",
                              "include_lower": true,
                              "include_upper": true,
                              "boost": 1
                            }
                          }
                        }
                      ],
                      "adjust_pure_negative": true,
                      "boost": 1
                    }
                  },
                  "parent_type": "ipInfo",
                  "score": false,
                  "ignore_unmapped": false,
                  "boost": 1
                }
              }
            ],
            "adjust_pure_negative": true,
            "boost": 1
          }
        }
      ],
      "adjust_pure_negative": true,
      "boost": 1
    }
  }
}
```

##### 6. Select *,Has Child
```java
@Test
public void testHasChild(){
    String sql="select * from device_search where has_child('imageInfo',portInfo.port in (10,20,30),1,4)";
    ElasticSql2DslParser sql2DslParser=new ElasticSql2DslParser();
    ElasticSqlParseResult parseResult = sql2DslParser.parse(sql);
    System.out.println(parseResult.toPrettyDsl(parseResult.toRequest()));
}
```
解析之后的DSL
```json
{
  "from": 0,
  "size": 15,
  "query": {
    "bool": {
      "filter": [
        {
          "bool": {
            "must": [
              {
                "has_child": {
                  "query": {
                    "bool": {
                      "must": [
                        {
                          "terms": {
                            "portInfo.port": [
                              10,
                              20,
                              30
                            ],
                            "boost": 1
                          }
                        }
                      ],
                      "adjust_pure_negative": true,
                      "boost": 1
                    }
                  },
                  "type": "imageInfo",
                  "score_mode": "none",
                  "min_children": 1,
                  "max_children": 4,
                  "ignore_unmapped": false,
                  "boost": 1
                }
              }
            ],
            "adjust_pure_negative": true,
            "boost": 1
          }
        }
      ],
      "adjust_pure_negative": true,
      "boost": 1
    }
  }
}
```

##### 7. Select *, =, In, And, Not In, Between And, Or, Order By[Desc], Limit

```java
@Test
public void testVulInfo(){
    String sql="select * from device_search where (deviceCategory in ( 'SS','VSS' ) and  resType ='vul_info' and vulInfo.vulExist='true' and portInfo.deviceInfo.deviceCategory not in ('Monitor','Network Equipment','OA','Voice and Video','Room Wiring') and lastModified between 1533398400000 and 1550737921037 ) or (portInfo.port >=80 and ipInfo.ip='10.10.2.222') order by lastModified desc  limit 0,10";
    ElasticSql2DslParser sql2DslParser=new ElasticSql2DslParser();
    ElasticSqlParseResult parseResult = sql2DslParser.parse(sql);
    System.out.println(parseResult.toPrettyDsl(parseResult.toRequest()));
}
```
解析之后的DSL
```json
{
  "from": 0,
  "size": 10,
  "query": {
    "bool": {
      "filter": [
        {
          "bool": {
            "should": [
              {
                "bool": {
                  "must": [
                    {
                      "terms": {
                        "deviceCategory": [
                          "SS",
                          "VSS"
                        ],
                        "boost": 1
                      }
                    },
                    {
                      "term": {
                        "resType": {
                          "value": "vul_info",
                          "boost": 1
                        }
                      }
                    },
                    {
                      "term": {
                        "vulInfo.vulExist": {
                          "value": "true",
                          "boost": 1
                        }
                      }
                    },
                    {
                      "bool": {
                        "must_not": [
                          {
                            "terms": {
                              "portInfo.deviceInfo.deviceCategory": [
                                "Monitor",
                                "Network Equipment",
                                "OA",
                                "Voice and Video",
                                "Room Wiring"
                              ],
                              "boost": 1
                            }
                          }
                        ],
                        "adjust_pure_negative": true,
                        "boost": 1
                      }
                    },
                    {
                      "range": {
                        "lastModified": {
                          "from": 1533398400000,
                          "to": 1550737921037,
                          "include_lower": true,
                          "include_upper": true,
                          "boost": 1
                        }
                      }
                    }
                  ],
                  "adjust_pure_negative": true,
                  "boost": 1
                }
              },
              {
                "bool": {
                  "must": [
                    {
                      "range": {
                        "portInfo.port": {
                          "from": 80,
                          "to": null,
                          "include_lower": true,
                          "include_upper": true,
                          "boost": 1
                        }
                      }
                    },
                    {
                      "term": {
                        "ipInfo.ip": {
                          "value": "10.10.2.222",
                          "boost": 1
                        }
                      }
                    }
                  ],
                  "adjust_pure_negative": true,
                  "boost": 1
                }
              }
            ],
            "adjust_pure_negative": true,
            "boost": 1
          }
        }
      ],
      "adjust_pure_negative": true,
      "boost": 1
    }
  },
  "sort": [
    {
      "lastModified": {
        "order": "desc"
      }
    }
  ]
}
```

##### 8. 深层聚类(默认为平行聚类)
```java
@Test
public void testParseFlatTermsAgg(){
    String sql="select * from device_search where portInfo.port is not null and ipInfo.ip is not null group by terms(portInfo.port,5000),terms(ipInfo.ip,100)";
    ElasticSql2DslParser sql2DslParser=new ElasticSql2DslParser();
    ElasticSqlParseResult parseResult = sql2DslParser.parse(sql);
    parseResult.setTopStatsAgg(false); //设为false即为深层聚类，默认为true，即平行聚类
    System.out.println(parseResult.toPrettyDsl(parseResult.toRequest()));
}
```
解析之后的DSL
```json
{
  "from": 0,
  "size": 15,
  "query": {
    "bool": {
      "filter": [
        {
          "bool": {
            "must": [
              {
                "exists": {
                  "field": "portInfo.port",
                  "boost": 1
                }
              },
              {
                "exists": {
                  "field": "ipInfo.ip",
                  "boost": 1
                }
              }
            ],
            "adjust_pure_negative": true,
            "boost": 1
          }
        }
      ],
      "adjust_pure_negative": true,
      "boost": 1
    }
  },
  "aggregations": {
    "portInfo.port_terms": {
      "terms": {
        "field": "portInfo.port",
        "size": 5000,
        "shard_size": 10000,
        "min_doc_count": 1,
        "shard_min_doc_count": 1,
        "show_term_doc_count_error": false,
        "order": [
          {
            "_count": "desc"
          },
          {
            "_key": "asc"
          }
        ]
      },
      "aggregations": {
        "ipInfo.ip_terms": {
          "terms": {
            "field": "ipInfo.ip",
            "size": 100,
            "shard_size": 200,
            "min_doc_count": 1,
            "shard_min_doc_count": 1,
            "show_term_doc_count_error": false,
            "order": [
              {
                "_count": "desc"
              },
              {
                "_key": "asc"
              }
            ]
          }
        }
      }
    }
  }
}
```

##### 9. Max, Min, Avg, Sum
```java
@Test
public void min(){
    String sql="select max(portInfo.port),min(portInfo.port),sum(portInfo.port),avg(portInfo.port) from device_search";
    ElasticSql2DslParser elasticSql2DslParser=new ElasticSql2DslParser();
    ElasticSqlParseResult elasticSqlParseResult = elasticSql2DslParser.parse(sql);

    System.out.println(elasticSqlParseResult.toPrettyDsl(elasticSqlParseResult.toRequest()));
}
```
解析之后的DSL
```json
{
  "from": 0,
  "size": 15,
  "query": {
    "match_all": {
      "boost": 1
    }
  },
  "aggregations": {
    "max_portInfo.port": {
      "max": {
        "field": "portInfo.port"
      }
    },
    "min_portInfo.port": {
      "min": {
        "field": "portInfo.port"
      }
    },
    "sum_portInfo.port": {
      "sum": {
        "field": "portInfo.port"
      }
    },
    "avg_portInfo.port": {
      "avg": {
        "field": "portInfo.port"
      }
    }
  }
}
```

##### 10. Query打分，Boost设置权重
```java
@Test
public void query(){
    String sql="SELECT * FROM product.apple QUERY term(productName, 'iphone6s', 'boost:2.0f')";
    ElasticSql2DslParser elasticSql2DslParser=new ElasticSql2DslParser();
    ElasticSqlParseResult elasticSqlParseResult = elasticSql2DslParser.parse(sql,new String[]{"productName"});
    System.out.println(elasticSqlParseResult.toPrettyDsl(elasticSqlParseResult.toRequest()));
}
```
解析之后的DSL
```json
{
  "from": 0,
  "size": 15,
  "query": {
    "bool": {
      "must": [
        {
          "term": {
            "productName": {
              "value": "iphone6s",
              "boost": 2
            }
          }
        }
      ],
      "adjust_pure_negative": true,
      "boost": 1
    }
  }
}
```

##### 11. Nested
🐖 为了表征**nested path**这个属性,采用 $ 符号指明 <br/>
nested path必须以 $ 在**为nested类型的属性之前**结尾（非常重要）中间是否是以 $ 连接的不重要

<font color="red"><b>重要:</b></font>以`portInfo`的`bannerList`为例，`bannerList`为`nested`类型，则查询时的**nested path**应该为`portInfo.bannerList`
以下两种写法均**正确**
```
$portInfo$bannerList.banner
portInfo$bannerList.banner
```
下面这几种写法**错误**
```
portInfo.bannerList$banner
$portInfo.bannerList$banner
$portInfo$bannerList$banner
portInfo$bannerList$banner
```
参照portInfo中的bannerList的结构定义
```json
"portInfo" : {
    "properties" : {
        "OS" : {
        "type" : "text"
        },
        "bannerList" : {
            "type" : "nested",
            "properties" : {
                "banner" : {
                "type" : "text"
                },
                "encoding" : {
                "type" : "keyword"
                },
                "priv_error" : {
                "type" : "text"
                },
                "priv_status" : {
                "type" : "boolean"
                },
                "req_data" : {
                "type" : "text"
                },
                "req_name" : {
                "type" : "keyword"
                },
                "timestamp" : {
                "type" : "long"
                }
            }
        }
    }
}
```


```java
@Test
public void nested(){
    String sql="SELECT * FROM device_search WHERE $portInfo$bannerList.banner = 'usa'";
    ElasticSql2DslParser elasticSql2DslParser=new ElasticSql2DslParser();
    ElasticSqlParseResult elasticSqlParseResult = elasticSql2DslParser.parse(sql);
    System.out.println(elasticSqlParseResult.toPrettyDsl(elasticSqlParseResult.toRequest()));
}
```
解析之后的DSL
```json
{
  "from": 0,
  "size": 15,
  "query": {
    "bool": {
      "filter": [
        {
          "bool": {
            "must": [
              {
                "nested": {
                  "query": {
                    "term": {
                      "portInfo.bannerList.banner": {
                        "value": "usa",
                        "boost": 1
                      }
                    }
                  },
                  "path": "portInfo.bannerList",
                  "ignore_unmapped": false,
                  "score_mode": "none",
                  "boost": 1
                }
              }
            ],
            "adjust_pure_negative": true,
            "boost": 1
          }
        }
      ],
      "adjust_pure_negative": true,
      "boost": 1
    }
  }
}
```

##### 12. 全文检索
```java
@Test
    public void queryString(){
        String sql="select * from device_search where query_string('大华')";
        ElasticSql2DslParser sql2DslParser=new ElasticSql2DslParser();
        ElasticSqlParseResult parseResult = sql2DslParser.parse(sql);
        System.out.println(parseResult.toPrettyDsl(parseResult.toRequest()));
    }
```
解析后的DSL
```json
{
  "from": 0,
  "size": 15,
  "query": {
    "bool": {
      "filter": [
        {
          "bool": {
            "must": [
              {
                "query_string": {
                  "query": "大华",
                  "fields": [],
                  "type": "best_fields",
                  "default_operator": "or",
                  "max_determinized_states": 10000,
                  "enable_position_increments": true,
                  "fuzziness": "AUTO",
                  "fuzzy_prefix_length": 0,
                  "fuzzy_max_expansions": 50,
                  "phrase_slop": 0,
                  "escape": false,
                  "auto_generate_synonyms_phrase_query": true,
                  "fuzzy_transpositions": true,
                  "boost": 1
                }
              }
            ],
            "adjust_pure_negative": true,
            "boost": 1
          }
        }
      ],
      "adjust_pure_negative": true,
      "boost": 1
    }
  }
}
```

##### 13. Script
```java
@Test
public void scriptTest(){
	String sql="select * from device_search where script_query('if (ctx._source.user == \"kimchy\") {ctx._source.likes++;}','name:iamazy,age:23,gender:male')";
	ElasticSql2DslParser elasticSql2DslParser=new ElasticSql2DslParser();
	ElasticSqlParseResult elasticSqlParseResult = elasticSql2DslParser.parse(sql);
	System.out.println(elasticSqlParseResult.toPrettyDsl(elasticSqlParseResult.toRequest()));
}
```
解析后的DSL
```json
{
  "from" : 0,
  "size" : 15,
  "query" : {
    "bool" : {
      "filter" : [ {
        "bool" : {
          "must" : [ {
            "script" : {
              "script" : {
                "source" : "if (ctx._source.user == \"kimchy\") {ctx._source.likes++;}",
                "lang" : "painless",
                "params" : {
                  "gender" : "male",
                  "name" : "iamazy",
                  "age" : 23
                }
              },
              "boost" : 1.0
            }
          } ],
          "adjust_pure_negative" : true,
          "boost" : 1.0
        }
      } ],
      "adjust_pure_negative" : true,
      "boost" : 1.0
    }
  }
}
```

##### 14. GeoDistance
```java
@Test
public void geoDistance(){
    String sql="SELECT * FROM product.apple group by geo_distance(name#km,origin(12.0,14.0),range(0.0,100.0),range('*',100.0)),terms(name,101)";
    ElasticSql2DslParser elasticSql2DslParser=new ElasticSql2DslParser();
    ElasticSqlParseResult elasticSqlParseResult = elasticSql2DslParser.parse(sql);
    System.out.println(elasticSqlParseResult.toPrettyDsl(elasticSqlParseResult.toRequest()));
}
```
解析之后的DSL
```json
{
  "from" : 0,
  "size" : 15,
  "query" : {
    "match_all" : {
      "boost" : 1.0
    }
  },
  "aggregations" : {
    "name_geo_distance" : {
      "geo_distance" : {
        "field" : "name",
        "origin" : {
          "lat" : 12.0,
          "lon" : 14.0
        },
        "ranges" : [ {
          "key" : "*-100.0",
          "from" : 0.0,
          "to" : 100.0
        }, {
          "key" : "*-100.0",
          "from" : 0.0,
          "to" : 100.0
        } ],
        "keyed" : false,
        "unit" : "km",
        "distance_type" : "ARC"
      }
    },
    "name_terms" : {
      "terms" : {
        "field" : "name",
        "size" : 101,
        "shard_size" : 202,
        "min_doc_count" : 1,
        "shard_min_doc_count" : 1,
        "show_term_doc_count_error" : false,
        "order" : [ {
          "_count" : "desc"
        }, {
          "_key" : "asc"
        } ]
      }
    }
  }
}
```